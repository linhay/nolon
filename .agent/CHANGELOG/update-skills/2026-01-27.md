# Skills & Workflows 迭代复盘 - 2026-01-27

## 0. 对话概览
本次任务旨在修复通过 `nln://` 或 `nolon://` 自定义协议链接添加仓库的功能。修复过程中解决了三个层面的问题：URL 解析增强、macOS 多窗口冲突、以及 SwiftUI 视图状态同步（@State 缓存）。

## 1. 本次使用的 Skills / Workflows
- `/ios-debugger-agent`（参考了思路，主要手动分析日志）
- `/update-agent-skills-workflows`（当前正在执行）

## 2. 负反馈记录
- **解析不完全**：最初的 `extractSubpath` 无法处理完整的 HTTPS URL，导致无法自动带入子路径。
- **多窗口干扰**：点击链接时由于 `handlesExternalEvents` 的过度匹配和 `AppDelegate` 的冲突逻辑，导致同时打开了 3 个窗口。
- **逻辑断裂**：在尝试修复多窗口问题时，错误的禁用了 URL 接收路径，导致点击链接无反应。
- **状态不同步**：即使 URL 接收逻辑走通，由于 `AddRepositorySheet` 使用 `@State` 缓存了 ViewModel，第二次触发无法更新 UI。

## 3. 习惯/风格学习（偏好沉淀）
- **scope**: macOS App 开发 (SwiftUI)
- **do**: 
  - 处理 URL Scheme 时，优先考虑单窗口模式，避免生成多实例。
  - 在 Sheet 中使用 `@State` 持有 ViewModel 时，必须通过 `onAppear` 显式同步外部状态（如 `pendingImportURL`）。
  - URL 正则/解析代码需要考虑协议头（scheme）的存在，不能假定输入总是简写格式。
- **dont**:
  - 禁止在 `WindowGroup` 上使用通配符匹配 `handlesExternalEvents`，除非明确需要多窗口支持。
  - 禁止在视图更新循环中同步发布（Publish）变更信息。

## 4. 现有 Skills / Workflows 迭代建议
- **swift-coding-standards.md**:
  - 增加关于 SwiftUI 视图生命周期内状态同步的准则。
  - 增加关于 macOS 窗口管理的准则。

## 5. 新增 Skill / Workflow 建议
- **新增 Skill: `macos-app-development.md`**: 专门记录 macOS 特有的多窗口处理、URL Scheme 注册与接收、以及与 iOS 开发的差异项。
